# Web服务器

## Web服务器简介

### Web服务器的实现

Web服务器实现了HTTP和相关的TCP连接处理。负责管理Web服务器提供的资源，以及对Web服务器的配置、控制及扩展方面管理。

Web服务器逻辑实现了HTTP协议、管理者Web资源，并负责提供Web服务器的管理功能。Web服务器逻辑和操作系统共同负责管理TCP连接。底层操作系统负责管理底层计算机系统的硬件细节，并提供了TCP/IP网络支持、负责转载Web资源的文件系统记忆控制当前计算机活动的进程管理功能。

### 通用软件Web服务器

通用软件Web服务器都运行在标准的、有网络功能的计算机系统上。

### Web服务器设备

Web服务器设备是预先打包好的软硬件解决方案。厂商会在他们选择的计算机平台商预先安装好软件服务器，并将软件配置好。

应用解决方案不再需要安装及配置软件，通常可以极大地简化管理工作。但是Web服务器通常不太灵活，特性不太丰富，而且服务器硬件也不太容易重用或升级。

### 嵌入式Web服务器

嵌入式服务器时要嵌入到消费类产品中去的小型Web服务器。嵌入式Web服务器允许用户通过编写的Web浏览器接口来管理其消费者设备。

## 实际的Web服务器会做些什么

1. 建立连接——接受一个客户端连接，或者如果不希望与客户端建立连接，就将其关闭。
2. 接受请求——从网络中读取一条HTTP请求报文。
3. 处理请求——对请求报文进行解释，并采取行动。
3. 访问资源——访问报文中指定的资源。
4. 构建响应——创建带有正确首部的HTTP响应报文。
5. 发送响应——将响应回送给客户端。
6. 记录事务处理过程——将与已完成事务有关的内容记录在一个日志文件中。


## 第一步———接受客户端连接

### 处理新连接

客户端请求一条道Web服务器的TCP连接时，Web服务器会建立连接，判断连接的另一端是哪个客户端，从TCP连接中将IP地址解析出来。一旦新连接建立起来并被接受，服务器就会将新连接添加到其现存Web服务器链接列表中，做好监视连接上数据传输的准备。

Web服务器可以随意拒绝或立即关闭任意一条连接。有些Web服务器会因为客户端IP地址或主机名是未认证的，或者因为他是已知的恶意客户端而关闭连接。Web服务器也可以使用其他识别技术。

### 客户端主机名识别

可以用“反向DNS”对大部分Web服务器进行配置，比如将客户端IP地址转换成客户端主机名。弹药注意的是，主机名查找可能会花费很长时间，这样会降低Web事务处理的速度。很多大量Web服务器要么会禁止主机名解析，要么只允许对特定内容进行解析。

### 通过ident确定客户端用户
有些Web服务器还支持IETF的ident协议。服务器可以通过ident协议找到发起HTTP连接的用户名。

ident在组织内部可以很好地工作，但出于多种原因，在公共因特网上并不能很好地工作。原因包括：

* 很多客户端PC没有运行ident识别协议守护进程软件；
* ident协议会使HTTP事务处理产生严重的时延；
* 很多放火请不允许ident流量进入；
* ident协议不安全，容易被伪造；
* ident协议也不支持xuniIP地址；
* 暴露客户端的用户名还涉及隐私问题。

## 第二步——接收请求报文

* 解析请求行，查找请求方法、指定的资源标识符（URI）以及版本号，各项之间有一个空格分隔，并以一个回车换行序列作为行的结束；
* 读取以CRLF结尾的报文首部；
* 检测到以CRLF结尾的、表示首部结束的空行；
* 如果有的话（长度有Content-Length首部指定），读取请求主体。

### 报文的内部表示方法 
报文有些Web服务器还会用便于进行报文操作的内部数据结构来存储请求报文。比如，数据结构中可能包含有指向请求报文中各个片段的指针及其长度，这样就可以将这些首部存放在一个快速查询表中，以便快速访问特定首部的具体值了。

### 连接的输入/输出处理结构

高性能的Web服务器能够同时支持数千条连接。不同的Web服务器结构会以不同的方式为请求服务。

>单线程Web服务器
>>
>单线程的Web服务器一次只处理一个请求，直到其完成为止。一个事务处理结束之后，才会处理吓一跳连接。这种结构易于实现，但在处理过程中，所有其他连接都会被忽略。这样会造成严重的性能问题，只适用于低负荷的服务器，以及type-o-serve这样的诊断工具。

>多进程及多线程Web服务器
>>多进程和多线程Web服务器用多个进程，或更高效的线程同时对请求进行处理。可以根据需要创建，或者预先创建一些线程/进程。有些服务器会对每条连接分配一个线程/进程，但当服务器同时要处理成百、上千、甚至数以百计的连接时，需要的进程或线程数量可能会消耗太多的内存或系统资源。因此，很多多线程Web服务器都会对线程/进程的最大数量进行限制。

>复用的I/O的服务器
>>为了支持大量的连接，很多Web服务器都采用了复用结构。在复用结构中，要同时监听所有连接上的活动。当连接的状态发生变化时，就对那条连接进行少量的处理；处理结束之后，将连接返回到开放链接列表中，等待下一次状态变化。只有在有事情可做时才会对连接进行处理；在空闲连接上等待的时候并不会绑定线程和进程。

>复用的多线程Web服务器
>>有些系统会将多线程和复用功能结合在一次，一利用计算机平台上的多个CPU。多个线程（通常是一个屋里处理器）中的每一个都在观察打开的连接，并对每条连接执行少量的任


## 第三步——处理请求

一旦Web服务器收到了请求，就可以根据方法、资源、首部和可选的主体部分来对请求进行处理了。

## 第四步——对资源的映射及访问

Web服务器是资源服务器。他们负责发送预先穿件好的内容，以及运行在服务器上的资源生成程序所产生的动态内容。

在Web服务器将内容传送给客户端之前，要将请求报文中的URI映射为Web服务器适当的内容或生成器，易识别出内容的源头。