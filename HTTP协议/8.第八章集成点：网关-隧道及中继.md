# 第八章 集成点：网关、隧道及中继

## 8.1 网关

HTTP扩展和接口的发展是由用户需求驱动的。要在Web上发布更复杂资源的需求出现时，人们很快就明确了一点：单个应用程序无法处理所有这些能想到的资源。

为了解决这个问题，开发者提出了网关的概念，网关可以作为某种翻译器使用，它抽象出了一种能够到达资源的方法。网关是资源和应用程序之间的粘合剂。应用程序可以请求网关来处理某条请求，网关可以提供一条响应。网关可以向数据库发送查询语句，或者生成动态的内容，就像一个门一样：进去一条请求，出来一个响应。

有些网关会自动将HTTP流量转换为其他协议，这样HTTP客户端无需了解其他协议，就可以与其他应用程序进行交互了。

下图显示了三个网关的示例：
![](https://i.imgur.com/M5usJP2.png)

* 在（a）中，网关收到了对FTP URL的HTTP请求。然后网关打开FTP连接，并向FTP服务器发布适当的命令。然后将文档和正确的HTTP首部通过HTTP回送。
* 在（b）中，网关通过SSL收到了一条加密的Web请求，网关会对请求进行解密，然后向目标服务器转发一条普通的HTTP请求。可以讲这些安全加速器直接放在Web服务器前面，以便为原始服务器提供高性能的加密机制。
* 在（c）中，网关通过应用程序服务器网关的API，将HTTP客户端连接到服务器短的应用程序上去。在王冠的电子商店购物。查看天气预报，或者获取股票报价时，访问的就是应用程序服务器网关。

**客户端和服务器端网关**

可以用一个斜杠来分隔客户端和服务器端协议，并以此对网关进行描述：

	<客户端协议>/<服务器端协议>

因此，将HTTP客户端连接到NNTP新闻服务器的网关就是一个HTTP/NNTP网关。我们用术语服务器端网关和客户端网关来说明对话谁在网关的那一侧进行的。

* 服务器网关：通过HTTP与客户端对话，通过其他协议与服务器通信（HTTP/*）
* 客户端网关：通过其他协议与客户端对话，通过HTTP与服务器通信（*/HTTP）

## 8.2 协议网关

将HTTP流量导向网关时所使用的方式与将流量导向代理的方式相同。最常见的方式是，显示地配置浏览器使用网关，对流量进行透明拦截，或者将网关配置为替代者。

### 8.2.1 HTTP/*：服务器端Web网关

请求流入原始服务器时，服务器端Web网关会将客户端HTTP请求转换为其他协议

当网关收到一条对FTP自愿请求的HTTP请求：
	
	FTP：//irs.gov/pub/00-index.txt

网关就会打开一条到原始服务器FTP端口的FTP连接，通过FTP协议获取对象。网关会做下列事情：

* 发送USER和PASS命令登录到服务器上去
* 发布CWD命令，转移到服务器上合适的目录中去
* 将下载类型设置为ASCII；
* 用MDTM获取文档的最后修改时间；
* 用PASV告诉服务器将有被动数据获取请求到达；
* 用TETR请求进行对象获取；
* 打开到FTP服务器的数据连接，服务器端口由控制信道返回；一旦数据信道打开了，就将对象内容会送给网关。

完成获取之后，会将对象放在一条HTTP响应中送给客户端。

### 8.2.2 HTTP、HTTPS：服务器端安全网关

一个组织可以通过网关对所有的输入Web请求加密，以提供额外的隐私和安全性保护。客户端可以用普通的HTTP浏览Web内容，但网关会自动加密用户的对话。

### 8.2.3 HTTPS/HTTP客户端安全加速器网关

最近，将HTTPS/HTTP网关作为安全加速器使用的请款是越来越多了。这些HTTPS、HTTP网关唯一Web服务器之前，通常作为不可兼得拦截网关或反向代理使用。它们接受安全地HTTPS流量，对安全流量进行解密，并向Web服务器发送普通的HTTP请求。

这些网关中通常都包含专用的解密硬件，以比原始服务器有效得多的方式来揭秘安全流量，以江青原始服务器的负荷。这些网关在网关和原始服务器之间放的是加密的流量，所以要谨慎使用，确保网关和原始服务器之间的网络是安全的。

## 8.3 资源网关

到目前为止，我们一直在讨论通过网络连接客户端和服务器的网关。但最常见的网关，应用程序服务器，会将目标服务器与玩骨干结合在一个服务器中实现。应用程序服务器是服务器端网关，与客户端通过HTTP进行通信，并与服务器端的应用程序相连。

两个客户端是通过HTTP连接到应用程序服务器的。但应用程序服务器并没有回送文件，而是将请求通过一个网关应用编程接口发送给运行在服务器上的应用程序。

第一个流行的应用程序网关API就是通用网关接口（CGI）。CGI是一个标准接口集，Web服务器可以用它来装载程序以响应对特定URL的HTTP请求，并收集程序的输出数据，将其放在HTTP响应中回送。

请求需要使用网关的资源时，服务器会请辅助应用程序来处理请求。服务器会将辅助应用程序所需的数据传送给它。通常就是整条请求，或者用户想在数据库上运行的请求之类的东西。

然后，它会向服务器返回一条响应或响应数据，服务器则会将其转服给客户端。服务器和网关是相互独立的应用程序，因此，它们的职责是分的是很清楚的。

这个简单的协议（输入请求，转交，响应）就是最古老，也最常用的服务器扩展接口CGI的本质。

### 8.3.1

CGI是第一个，可能仍然是得到最广泛使用的服务器扩展。在Web上广泛用于动态HTML、信用卡处理以及数据库查询等任务。

CGI应用程序是独立于服务器的，所以，几乎可以用热议语言来实现。CGI很简单，几乎所有的HTTP服务器都支持它。

CGI的处理对于用户来说是不可见的。从客户端的角度来看，就像发起一个普通请求一样。它完全不清楚服务器和CGI应用程序之间的转接过程。URL中出现字符cgi和可能出现的“？”是客户端发现使用了CGI的唯一线索。

CGI在服务器和众多的资源类型智联提供了一种简单的、函数形式的粘合方式，用来处理各种需要的转换。这个借口还能很好地保护服务器，防止一些糟糕的扩展对它造成的破坏（如果这些扩展直接与服务器相连，造成的错误可能会引发服务器崩溃）。

但是，这种分离造成性能的耗费。为每条CGI请求引发一个新进程的开销是很高的，会限制那些使用CGI的服务器的性能，并且会加重服务器端及其资源的负担。为了解决这个问题，人们开发了一种新型CGI-并将其恰当地称为快速CGI。这个借口模拟了CGI，但它是作为持久守护进程运行的，消除了为每个请求见了或拆除新进程所带来的性能损耗。

### 8.3.2 服务器扩展API

CGI协议为外部翻译器与现有的HTTP服务器提供了一种间接地接口方式，但如果想要改变服务器自身的行为，或者只是想尽可能地提升服务器上获得的性能呢？服务器开发者为两种需求提供了几种服务器扩展API，为Web开发者提供了强大的接口，以便他们将自己的模块与HTTP服务器直接相连。扩展API允许程序员将自己的代码嫁接到服务器上，或者用自己的代码将服务器的一个组件完整地替换出来。

大多数流行的服务器都会为开发者提供一个或多个扩展API。这些扩展都会绑定在服务器自身的结构上，所以，大多数都是某种服务器类型特有的。

## 8.4 应用程序接口和Web服务

我们已经讨论过可以将资源网关作为Web服务器与应用程序的通信方式使用。更广泛地说，随着Web应用程序提供的服务类型越来越多，有一点变得越清晰了：HTTP可以作为一种连接应用程序的基础软件来使用。在将应用程序连接起来的过程中，一个更为棘手的问题是是在两个应用程序之间进行协议接口的协商，以便这些应用程序可以进行数据的交换——这通常都是针对具体应用程序的个案进行的。

应用程序之间要配合工作，所言交互的信息比HTTP首部所能标的的信息要复杂得多。

因特网委员会开发了一组允许Web应用程序之间相互通信的标准和协议。尽管Web服务可以用来表示独立的Web应用程序，这里我们还是宽松的用这个属于来标识这些标准。Web服务器的映入并不新鲜，但这是应用程序共享信息的一种新机制。Web服务是构建在标准的Web技术之上的

Web服务可以用XML通过SOAP来交换信息。XML提供了一张穿件数据对象的定制信息，并对其进行解释的方法。SOAP是向HTTP报文中添加XML信息的标准方式。

## 8.5 隧道

Web隧道允许用户通过HTTP连接发送非HTTP流量，这样就可以在HTTP上捎带其他协议数据了。使用Web隧道最常见的原因就是要在HTTP连接中嵌入非HTTP流量，这样，这类流量就可以穿过只允许Web流量通过的防火墙。

### 8.5.1 用CONNECT建立HTTP隧道

Web隧道使用HTTP的connect 方法建立起来的。connect方法并不是HTTP/1.1核心规范的一部分，但却是一种得到广泛应用的扩展。

CONNECT方法请求隧道网关创建一条到达任意目的服务器和端口的TCP连接，并对客户端和服务器之间的后技术局进行盲转发。
