# 第十一章 客户端识别和cookie机制

## 11.1 个性化接触

HTTP最初是一个匿名、无状态的请求/响应协议。现代Web站点希望能够提供个性化的接触。它们希望对连接另一端的用户有更多的了解，并且能在用户浏览页面时对其进行跟踪。Amazon.com这样流行的在线商店网站可以通过一下几种方式实现站点的个性化。
* 个性化的问候<br>专门为用户生成的欢迎词和内容页面，使购物体验更加个性化。
* 有的放失的推荐<br>通过了解客户的兴趣，商店可以推荐一些它们认为客户会感兴趣的商品。商店还可以在临近客户生日或其他一些重要日子的时候提供生日特定的商品。
* 管理信息的存档<br>在线购物的用户不喜欢一次又一次地填写繁琐的地址和信用卡信息，有些站点会将这些管理细节存储在一个数据库中。只要他们识别出用户，就可以使用存档的管理信息，使得购物体验更加便捷。
* 记录会话<br>HTTP事务是五转泰德。每条请求/响应都是独立进行的。很多Web站点希望能在用户与站点交互的过程中构建增量状态。要实现这一功能，Web站点就需要有一种方式来区分来自不同用户的HTTP事务。

本章对HTTP识别用户的几种技巧进行了总结。HTTP并不是天生就具有丰富的识别特性的。早起的Web站点设计者们都有自己的用户识别技术。每种技术都有其优势和劣势。

## 11.2 HTTP首部

表11-1给出了其中常见的用来承载用户相关信息的HTTP请求首部。这里我们先讨论前三个。

![](./img/11-1.png)

From首部包含了用户的E-mail地址。每个用户都有不同的E-mail地址，所以在理想情况下，可以将这个地址作为可行的源端来识别用户。但由于担心那些不讲道德的服务器会搜集这些E-mail地址，用于垃圾邮件的散发，搜易很少有浏览器会发送From首部。

User-Agent首部可以将用户受用浏览器的相关信息告知服务器，包括程序的买那个城和版本，通常还包含操作系统的相关信息。要实现定制内容与特定的浏览器及其属性的良好互操作时，这个首部是非常有用的，但它并没有为识别特定的用于提供太多有意义的帮助。

Referer首部提供了用户来源页面的URL。refer而首部自身并不能完全表示用户，但它却是说明了用于之前访问过哪个页面。通过它可以更好地理解用户的浏览行为，异界用户的兴趣所在。比如，如果你是从一个篮球网站抵达某个Web服务器的，这个服务器可能会推断你是个篮球迷。

## 11.3 客户端IP地址

如果每个用户都有不同的IP地址，IP地址也很少会发生变化，而且Web服务器可以判断出每条请求的客户端IP地址的话，这种方案是可行的。

但是，使用客户端IP地址来识别用户存在着很多缺点，限制了将其作为用户识别技术的效能。

* 客户端IP地址描述的是所用的机器，而不是用户。如果多个用户共享同一条计算机，就无法对其进行区分了。
* 很多因特网服务提供商都会在用户登录时为其动态分配IP地址。用户每次登录时，都会得到一个不同的地址，因此Web服务器不能假设IP低着可以在各登录会话之间表示用户。
* 为了提高安全性，并对稀缺的地址资源进行管理，很多用户都是通过网络地址转换(NAT)防火墙来浏览网络内容的。这些NAT设备隐藏了防火墙后面那些实际客户端的IP地址，将实际的客户端IP地址转换成了一个共享的防火墙IP地址（和不同的端口号）。
* HTTP代理和网关通常会打开一些新的、到原始服务器的TCP连接。Web服务器看到的监视代理服务器的IP地址，而不是客户端的。由此而代理为了绕过这个问题会添加特殊的Client-IP或X-Forwarded-For扩展首部来保存原始的IP地址。但并不是所有的代理都支持这种行为。

少数站点甚至将客户端IP地址作为一种安全特性使用，它们指向来自特定IP地址的用户提供文档。在内部网络中可能可以这么做，但在因特网上就不行了，主要是因为因特网上IP地址太容易被欺骗了。

## 11.4 用户登录
Web服务器无需被动地根据用户的IP地址来猜测他的身份，他可以要求用户通过用户名和密码进行认证来显示地询问用户是谁。

为了使Web站点的登录更加简便，HTTP中包含了一种内建机制，可以用WWW-Authenticate首部和Authorization首部向Web站点的请求中发送这个登录信息了，这样，就总是有登录信息可用了。

通过服务器向在为用户提供对站点的访问之前，现行登录，可以向浏览器回送一条HTTP响应代码401 Login Required。然后，浏览器会显示一个登录对话框，并用Authorization首部在吓一跳对服务器的请求中提供这些信息。

但是，登录多个站点是很繁琐的。Fred从一个站点浏览到另一个站点的时候，需要在每个站点上登录。更糟糕的是，可怜的Fred很可能要为不同的站点记住不同的用户名和密码。他访问很多站点的时候，他最喜欢的用户名Fred可能已经被其他人用过了，而且有些站点为用户面和密码的长度和组成设置了不同的规则。Fred很快就会放弃上网。

## 11.5 胖URL

有些Web站点会为没有用户生成特定版本的的URL来追踪用户的身份。通常，会对真正的URL进行扩展，在URL路径开始或结束的地方添加一些状态信息。用户浏览站点时，Web服务器会动态生成一些超链，继续维护URL中的状态信息。

改动后包含了用户状态信息的URL被称为胖URL（fat URL）。

可以通过胖URL将Web服务器上若干个独立的HTTP事务捆绑成一个回话或访问。用户首次访问这个Web站点时，会生成一个唯一的ID，用护肤武器可以识别的方式将这个ID添加到URL中去，然后服务器就会将客户端重新导向这个胖URL。不论什么时候，只要服务器收到了对胖URL的请求，就可以去查找与那个用户ID相关的艘油增量状态，然后重写所有的输出超链，使其成为胖URL，已维护用户的ID。

可以在用户浏览站点时，用胖URL对其进行识别。但这种技术存在记这个很严重的问题。

* 丑陋的URL<br>浏览器中显示的胖URL会给新用户带来困扰
* 无法共享URL<br>胖URL中包含了与特定用户和回话有短的状态信息。如果将这个URL发送给其他人，可能就在无意中将你积累的个人信息都共享出去了。
* 破坏缓存<br>为每个URL生成用户特有的版本就意味着不再有可供公共访问的URL需要缓存了。
* 额外的服务器负荷<br>服务器需要重写HTML页面使URL变胖。
* 逃逸口<br>用户跳转到其他站点或者请求一个特定的URL时，就很容易在无意中“逃离”胖URL回话。只有当用户严格的追随预先修改过的链接时，胖URL才能工作。古国用户逃离此链接，就会丢失他的进展信息，得重新开始。
* 在回话间是非持久的<br>除非用户手残了特定的胖URL，否则用户推出登录时，所有的信息都会丢失。

## 11.6 cookie

cookie是当前识别用户，实现持久会话的最好方式。前面各种技术中存在的很多问题对它们都没什么影响，但是通常会将它们与那些技术公用，以实现额外的价值。

cookie非常重要，而且它们定义了一些新的HTTP首部，所以我们要比前面那些技术更详细地介绍它们。cookie的存在也影响了缓存，大多数缓存和浏览器都不允许对任何cookie的内容进行缓存。

### 11.6.1 cookie的类型

可以笼统地将cookie分为两类：会话cookie和持久cookie。会话cookie是一种临时cookie，它记录了用户访问站点时的设置和偏好。用户推出浏览器时，会话cookie就被删除了。持久cookie的生存时间更长一些；它们存储在硬盘上，浏览器退出，计算机重启时它们仍然存在。通常会用持久cookie维护某个用户会周期性访问的站点的配置文件或登录名。

会话cookie和持久cookie之间唯一区别就是它们的过期时间。





