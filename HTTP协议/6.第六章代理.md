# 第六章 代理

## 6.1 Web的中间实体

Web上的代理服务器是代表客户端完成事务处理的中间人。如果没有Web代理，HTTP客户端就要直接与HTTP服务器进行对话。有了Web代理，客户端就可以与代理进行对话，然后由代理代表客户端与服务器进行交流。客户端仍然会完成对事物的处理，但它是通过代理服务器提供的优质服务来实现的。

HTTP的代理服务器既是Web服务器又是Web客户端。

### 6.1.1 私有和共享代理

> 公共代理
>>
>大多数代理都是公公打共享代理。集中式代理的费效比更高，更容易管理。某些代理应用。比如高速缓存代理服务器，会利用用户间共同的请求，这样的话，汇入同一个代理服务器的用户越多，它就越有用。

>私有代理
>>
>专用的私有代理并不常见，但他们确实存在，尤其是直接运行在客户端计算机上的时候。有些浏览器辅助产品，以及一些ISP服务，会在用户的PC上直接运行一些小型的代理，以便扩展浏览器特性，提高性能，或为免费ISP服务提供主机广告。

### 6.1.2 代理与网关的对比

严格来说，代理连接是两个或多个使用相同协议的应用程序，而网关连接的则是两个或多个使用不同协议的端点。

* HTTP代理与客户端和服务器之间使用的都是HTTP协议。
* HTTP/POP网关把HTTP的前台与POP E-mail的后端连接起来。网关将Web事务转换成适当的POP事务，这样用户就可以通过HTTP读取E-mail了。

实际上，代理和网关之间的区别很模糊。由于浏览器和服务器实现的不同版本的HTTP，代理也经常要做一些协议转换工作。而商业化的代理服务器也会实现王冠的功能来支持SSL安全协议、SOCKS防火墙、FTP访问，以及基于Web的应用程序。


## 6.2 为什么使用代理

代理服务器可以实现各种功能时髦且有用的功能。它们可以改善安全性，提高性能，节省费用。代理服务器可以看到并接触到所有流过的HTTP的流量，所以代理可以监视流量并对其进行修改，以实现很多有用的增值Web服务。这里给出了几种代理使用方法的事例。

>儿童过滤器
>>小学在为教育站点提供无阻碍访问的同时，可以利用过滤器代理来阻止学生访问成人内容。

>文档访问控制
>>
>可以用代理服务器在大量Web服务器和Web资源之间实现统一的访问控制策略，创建审核和跟踪机制。这在大型企业环境或其他分布式机构中是很有用的。
>>
>在集中式代理服务器上可以对所有访问控制功能进行配置，而无需在众多由不同组织管理、不同厂商制造、使用不同模式的Web服务器上进行经常性的访问控制升级

>安全防火墙
>>网络安全工程师通常会使用代理服务器来提高安全性。代理服务器会在网络中的单一安全节点上限制哪些应用层协议的数据可以流入或流出一个组织。还可以提供用来消除病毒的Web和E-mail代理用用的那种挂钩程序，以便对流量进行详细的检查。

>Web缓存
>>代理缓存维护了常用文档的本地副本，并将它们按需提供，以减少缓慢且昂贵的因特网通信。

>反向代理
>>代理可以假扮Web服务器。这些被称为替代物或反向代理的代理接收发给Web服务器的真实请求，但与Web服务器不同的是，它们可以发起与其他服务器的通信，以便按需定位所请求的内容。
>>
>可以用这些反向代理来提高访问慢速Web服务器上公共内容时的性能。在这种配置中，通常讲这些反向代理称为服务器加速器。还可以将替代物与内容路由功能配合使用，以创建按需复制内容的分布式网络。

>内容路由器
>>代理服务器可以作为“内容路由器”使用，根据因特网流量状况以及内容类型将请求导向特定的Web服务器。
>>
>内容路由器也可以用来实现各种服务级请求。比如，如果用户或内容提供者付费要求提供更高的性能，内容路由器可以将请求转发到附近的复制缓存，或者如果用户申请了过滤服务，还可以通过过滤代理来转发HTTP请求。可以用自适应内容路由代理来构建很多有趣的服务。

>转码器
>>代理服务器在内容发送给客户端之前，可以修改内容的主体格式。在这些数据表示法之间进行的透明转换被称为转码。
>>
>转码代理可以在传输GIF图片时，将其转换成JPEG图片，以减小尺寸。也可以图片进行压缩，火箭第颜色的色彩饱和度以便在电视上观看。同样，可以对文本文件进行压缩。代理甚至可以在传输文旦的过程中将其转换成外语。

>匿名者
>>
>匿名者代理会主动从HTTP报文章删除身份特性，从而提供高度的私密性和匿名性

## 6.3 代理会去往何处

### 6.3.1 代理服务器的部署

可以根据其目标用途，将代理放在任意位置。部署代理服务器的几种方式。

> 出口代理
> >
>可以将代理固定在本地网络的出口点，以便控制本地网络与大型因特网之间的流量。可以在公司网络中使用出口代理，提供针对公司外部恶意黑客的防火墙保护，或降低贷款费用，提高因特网流量的性能。

> 访问（入口）代理
> >代理常被放在ISP访问点上，泳衣处理来自客户和聚合请求。ISP使用缓存代理来存储常用文档的副本，以提高用户的下载速度，降低因特网带宽耗费。

> 反向代理
> >反向代理通常会被部署在网络边缘，在Web服务器之前，作为替代物使用，在那里它们可以处理所有传送给Web服务器的请求，并只在必要时向Web服务器请求资源。代替物可以提高Web服务器的安全特性，或者将可快速的Web服务器缓存放在较慢的服务器之前，以提高性能。反向代理通常会直接冒用Web服务器的名字和IP地址，这样所有的请求就会被发送给代理而不是服务器了。

>网络交换代理
>>可以将具有足够处理能力的代理放在网络之间的因特网对等交换上，通过缓存来减轻因特网节点的拥塞，并对流量进行监控。

### 6.3.2 代理的层次结构

可以通过代理层次结构将代理级联起来。在代理的层次结构中，会将报文从一个代理传给另一个代理，直到最终抵达原始服务器位置（然后通过代理传回给客户端）。

Proxy层次结构中的代理服务器被赋予了父（parent）和子（child）的关系。下一个入口代理被称为父代理，下一个出口代理被称为子代理。

但是层次不一定非得是静态的。代理服务器可以根据众多因素，将报文转发给一个不断变化的代理服务器和原始服务器集。

这里还有几个动态选择父代理的例子。

> 负载均衡
>> 子代理可能会根据当前父代理上的工作负载级别来决定如何选择一个父代理，以均衡负载。

>地理位置附近的路由
>>子代理可能会选择原始服务器所载物理区域的父代理。

> 协议/类型路由
> > 子代理可能会根据URI将报文转发到不同的父代理和原始服务器上去。某些特定类型的URI可能通过一些特殊代理服务器转发请求，以便进行特殊的协议处理。

>基于订购的路由
>>如果发布者为高性能服务额外付费了，它们的URI就会被转发到大型缓存或压缩引擎上去，以提高性能。

在不同的产品中，动态父路由逻辑的实现方式各有不同，包括使用配置文件、脚本语言和动态可执行插件等。

### 6.3.3 代理是如何获取流量的

客户端通常会直接与Web服务器进行通信，所以我们要解释清楚HTTP流量怎样才能首先流向代理。有四种常见方式可以使客户端流量流向代理。

>修改客户端
>>很多Web客户端，包括网景和微软的浏览器，都支持手工和自动的代理配置。如果将客户端配置为使用代理服务器，客户端就会将HTTP请求有意地直接发送给代理，而不是原始服务器。

>修改网络
>>网络基础设施可以通过若干种技术手段，在客户端不知道，或没有参与的情况下，拦截网络流量并将其导入代理。这种拦截通常都依赖与监视HTTP流量的交换设备及路由设备，在客户端毫不知情的情况下，对其进行拦截，并将流量导入一个代理。这种代理被称为拦截代理。

>修改DNS的命名空间
>>放在Web服务器之前的代理服务器———替代物，会直接假扮Web服务器的名字和IP地址，这样，所有的请求就会发送给这些替代物，而不是服务器了。要实现这一点，可以手工编辑DNS名称列表，或者用特殊的动态DNS服务器根据需要来确定适当的代理或服务器。

>修改Web服务器
>>也可以将某些Web服务器配置为向客户端发送一条HTTP重定向，将客户端请求重定向到一个代理上去。收到重定向命令后，客户端会与代理进行通信。

## 6.4 客户端的代理设置

所有现代的Web浏览器都允许用户对代理的使用进行配置。实际上，很多浏览器都提供了多种配置代理的方式。

>手工配置
>>显示地设置要是用的代理。

>预先配置浏览器
>>浏览器厂商或发行商会在将浏览器发送给其客户之前预先对浏览器（或其他Web客户端）的代理设置进行手工配置。

>代理的自动配置（PAC）
>提供一个URI，只想一个用JavaScript语言编写的代理自动配置文件，客户端会取回这个JavaScript文件，并运行它以决定是否应该使用一个代理，如果是的话，应该使用哪个代理服务器。

>WPAD的代理发现
>>有些服务器支持Web代理自动发现协议，这个协议会自动检测出浏览器可以从哪个“排至服务器”下载到一个自动配置文件


### 6.4.1客户端的代理配置：手工配置

浏览器都有不同的方式来进行手工配置的修改，但其思想是一样的：为代理指定主机和端口。有些ISP会向客户端发送预先配置好的浏览器，或指定好的操作系统，使其将Web流量重定向到代理服务器上。

### 6.4.2 客户端代理配置：PAC文件

手工代理配置很简单但有些死板。只能为所有内容指定唯一的一个代理服务器。而且不支持故障转移。如果配置过的浏览器基数很大，那么需要进行修改的时候，重新配置每个浏览器是非常困难，甚至是不可能的。

PAC文件是一些小型的JavaScript程序，可以在运行过程中计算代理设置，因此是一种更动态的代理配置解决方案。访问每个文档时，JavaScript函数都会选择恰当的代理服务器。

要是用PAC文件，就要用JavaScript PAC文件的URI来配置浏览器。浏览器会从这个URI上获取PAC文件，并用JavaScript逻辑为每次访问计算机恰当的代理服务器。PAC文件的后缀通常是.pac，MIME类型通常是applicationx-ns-proxy-autoconfig。

每个PAC文件都必须定义一个名为FindProxyForURl（url,host）的函数，用来计算访问URI时使用的适当的代理服务器。

### 6.4.3 客户端代理配置： WPAD

另一种浏览器配置机制是WPAD协议。 WPAD协议的算法会使用发现机制的逐级上升策略自动地为浏览器查找合适的PAC文件。实现WPAD协议的客户端需要：

* 用WPAD找到PAC的URI；
* 从指定的URI获取PAC文件；
* 执行PAC文件来判定代理服务器；
* 为请求使用代理服务器。

WPAD会使用一些列的资源发现技术来判定适当的PAC文件。并不是所有祖师都能够使用所有的发现技术，所以挖到使用了很多种发现技术。WPAD会一个接一个地对每种技术进行尝试，直到成功为止。

当前的WPAD协议规范按顺序定义了下列技术：

* 动态主机配置协议（DHCP）
* 服务定位协议（SLP）
* DNS知名主机名
* DNS SRV 记录
* TXT记录中的DNS服务URI


## 6.5 与其你去有关的一些棘手问题

### 6.5.1 代理URI与服务器URI的不同

车里一点之外，Web服务器报文和Web代理报文的语法是一样的。客户端向服务器而不是代理发送请求时，HTTP请求报文章的URI会有所不同。

客户端向Web服务器发送请求时，请求行中包含部分URI（没有方案、主机或端口号）

	GET /index.html HTTP/1.0
	User-Agent: SuperBrowser V1.3

但当客户端向代理方请求时，请求行中则包含完整的URI。

	GET http://www.marys-antiques.com/index.html HTTP/1.0
	User-Agent: SuperBrowser V1.3

在原始的HTTP设计中，客户端会直接与单个服务器进行对话。不存在虚拟主机，也没有为代理指定什么规则。单个的服务器都知道自己的主机名和端口号，所以，为了避免发送冗余信息，客户端只需发送部分URI即可，无需发送方案和主机。

代理出现之后，使用部分URI就有问题了。代理需要知道目标服务器的名称，这样它们才能建立自己与服务器的连接。基于代理的网关要知道URI的方案才能连接到FTP资源和其他方案上去。HTTP/1.0要求代理请求发送完整的URI，解决了这个问题，但它为服务器请求保留部分URI的形式（已经有相当多的服务器都改为支持完整URI了）

现在，HTTP/1.1要求服务器代理请求和服务器请求都提供完整的URI处理，但实际上，很多已部署的服务器仍然只接受部分URI。

因此，我们要将部分URI发送给服务器，将完整URI发送给代理。

1. 没有设置客户端使用代理是，它会发送部分URI
2. 设置客户端使用代理时，它会发送完整URI

### 6.5.2与虚拟主机一样的问题

代理“缺少方案/主机/端口”的问题与虚拟主机Web服务器面临的问题相同。虚拟主机Web服务器会在很多Web站点间共享同一个Web屋里服务器。包含部分URI的请求到达时，虚拟主机web服务器需要知道目的Web站点的主机名。

尽管它们出现的问题相似，但解决方法却有所不同：

* 显式的代理要求在请求报文中使用完整URI来解决这个问题；
* 虚拟主机Web服务器要求使用Host首部来承载主机和端口信息。


### 6.5.3 拦截代理会受到部分URI

只要客户端正确地狮子按了HTTP，它们就会在请求中包含完整的URI，发送给经过显式配置的代理。这样解决了部分问题，但还有一个问题：客户端并不总是知道它是在和代理进行对话，因为有些代理对客户端可能是不可兼得。及时没有将客户端配置为使用代理，客户端的流量也可能会经过替代物或拦截代理。在这两种情况下，客户端都会认为它在与Web服务器进行对话，不会发送完整的URI。

* 如前所述，反向代理是一个用来取代原始服务器的代理服务器，它通常会通过假扮服务器的主机名或IP地址来做到这一点。它会收到Web服务器请求，可能会向真正的服务器提供缓存的响应或者代理请求。客户端无法区分反向代理和Web服务器，因此它会发送部分URI。
* 拦截代理是网络流量中的代理服务器，它会拦截从客户端发往服务器的请求，并提供一个缓存响应，或对其进行转发。由于拦截代理拦截了客户端到服务器的流量，所以它会收到发送给Web服务器的部分URI。

### 6.5.4 代理级可以处理代理请求，也可以处理服务器请求

由于将流量重定向到代理服务器的方式有所不同，通过的代理服务器既应该支持请求报文中的完整URI，也应该支持部分URI。如果是显式的代理请求，代理就应该使用完整URI，如果是Web服务器请求，就应该使用部分URI和虚拟Host首部。

使用完整和部分URI的规则如下所示。

* 如果提供的是完整URI，代理就应该使用完整URI。
* 如果提供的是部分URI，而且有Host首部，就应该用Host首部来确定原始服务器的名字和端口号。
* 如果提供的是部分URI，而且没有Host首部，姐要用其他方法来确定原始服务器：
	 
	-如果代理是代表原始服务器的替代物，可以用真实服务器的地址和端口号来配置代理；

	-如果流量拦截了，而且拦截者也可以提供原始的IP地址和端口号，代理就可以使用拦截技术提供的IP地址和端口号

	-如果所有方法都失败了代理没有足够的信息来确定原始服务器，就必须返回一条错误报文（通常是建议用户升级到支持Host搜捕的现在浏览器）

### 转发过程中对URI的修改

代理服务器要在转发报文时修改请求URI的话，需要特别小心。对URI的微笑修改，甚至是看起来无害的修改，都可能给下游服务器带来一些互操作性问题。

总之，代理服务器要尽量宽容一些。他们的目标不是成为强制实现严格协议一致性的“协议警察”，因为这样可能会严重破坏之前能正常工作的服务。

