# 第六章 代理

## 6.1 Web的中间实体

Web上的代理服务器是代表客户端完成事务处理的中间人。如果没有Web代理，HTTP客户端就要直接与HTTP服务器进行对话。有了Web代理，客户端就可以与代理进行对话，然后由代理代表客户端与服务器进行交流。客户端仍然会完成对事物的处理，但它是通过代理服务器提供的优质服务来实现的。

HTTP的代理服务器既是Web服务器又是Web客户端。

### 6.1.1 私有和共享代理

> 公共代理
>>
>大多数代理都是公公打共享代理。集中式代理的费效比更高，更容易管理。某些代理应用。比如高速缓存代理服务器，会利用用户间共同的请求，这样的话，汇入同一个代理服务器的用户越多，它就越有用。

>私有代理
>>
>专用的私有代理并不常见，但他们确实存在，尤其是直接运行在客户端计算机上的时候。有些浏览器辅助产品，以及一些ISP服务，会在用户的PC上直接运行一些小型的代理，以便扩展浏览器特性，提高性能，或为免费ISP服务提供主机广告。

### 6.1.2 代理与网关的对比

严格来说，代理连接是两个或多个使用相同协议的应用程序，而网关连接的则是两个或多个使用不同协议的端点。

* HTTP代理与客户端和服务器之间使用的都是HTTP协议。
* HTTP/POP网关把HTTP的前台与POP E-mail的后端连接起来。网关将Web事务转换成适当的POP事务，这样用户就可以通过HTTP读取E-mail了。

实际上，代理和网关之间的区别很模糊。由于浏览器和服务器实现的不同版本的HTTP，代理也经常要做一些协议转换工作。而商业化的代理服务器也会实现王冠的功能来支持SSL安全协议、SOCKS防火墙、FTP访问，以及基于Web的应用程序。


## 6.2 为什么使用代理

代理服务器可以实现各种功能时髦且有用的功能。它们可以改善安全性，提高性能，节省费用。代理服务器可以看到并接触到所有流过的HTTP的流量，所以代理可以监视流量并对其进行修改，以实现很多有用的增值Web服务。这里给出了几种代理使用方法的事例。

>儿童过滤器
>>小学在为教育站点提供无阻碍访问的同时，可以利用过滤器代理来阻止学生访问成人内容。

>文档访问控制
>>
>可以用代理服务器在大量Web服务器和Web资源之间实现统一的访问控制策略，创建审核和跟踪机制。这在大型企业环境或其他分布式机构中是很有用的。
>>
>在集中式代理服务器上可以对所有访问控制功能进行配置，而无需在众多由不同组织管理、不同厂商制造、使用不同模式的Web服务器上进行经常性的访问控制升级

>安全防火墙
>>网络安全工程师通常会使用代理服务器来提高安全性。代理服务器会在网络中的单一安全节点上限制哪些应用层协议的数据可以流入或流出一个组织。还可以提供用来消除病毒的Web和E-mail代理用用的那种挂钩程序，以便对流量进行详细的检查。

>Web缓存
>>代理缓存维护了常用文档的本地副本，并将它们按需提供，以减少缓慢且昂贵的因特网通信。

>反向代理
>>代理可以假扮Web服务器。这些被称为替代物或反向代理的代理接收发给Web服务器的真实请求，但与Web服务器不同的是，它们可以发起与其他服务器的通信，以便按需定位所请求的内容。
>>
>可以用这些反向代理来提高访问慢速Web服务器上公共内容时的性能。在这种配置中，通常讲这些反向代理称为服务器加速器。还可以将替代物与内容路由功能配合使用，以创建按需复制内容的分布式网络。

>内容路由器
>>代理服务器可以作为“内容路由器”使用，根据因特网流量状况以及内容类型将请求导向特定的Web服务器。
>>
>内容路由器也可以用来实现各种服务级请求。比如，如果用户或内容提供者付费要求提供更高的性能，内容路由器可以将请求转发到附近的复制缓存，或者如果用户申请了过滤服务，还可以通过过滤代理来转发HTTP请求。可以用自适应内容路由代理来构建很多有趣的服务。

>转码器
>>代理服务器在内容发送给客户端之前，可以修改内容的主体格式。在这些数据表示法之间进行的透明转换被称为转码。
>>
>转码代理可以在传输GIF图片时，将其转换成JPEG图片，以减小尺寸。也可以图片进行压缩，火箭第颜色的色彩饱和度以便在电视上观看。同样，可以对文本文件进行压缩。代理甚至可以在传输文旦的过程中将其转换成外语。

>匿名者
>>
>匿名者代理会主动从HTTP报文章删除身份特性，从而提供高度的私密性和匿名性

## 6.3 代理会去往何处

### 6.3.1 代理服务器的部署

可以根据其目标用途，将代理放在任意位置。部署代理服务器的几种方式。

> 出口代理
> >
>可以将代理固定在本地网络的出口点，以便控制本地网络与大型因特网之间的流量。可以在公司网络中使用出口代理，提供针对公司外部恶意黑客的防火墙保护，或降低贷款费用，提高因特网流量的性能。

> 访问（入口）代理
> >代理常被放在ISP访问点上，泳衣处理来自客户和聚合请求。ISP使用缓存代理来存储常用文档的副本，以提高用户的下载速度，降低因特网带宽耗费。

> 反向代理
> >反向代理通常会被部署在网络边缘，在Web服务器之前，作为替代物使用，在那里它们可以处理所有传送给Web服务器的请求，并只在必要时向Web服务器请求资源。代替物可以提高Web服务器的安全特性，或者将可快速的Web服务器缓存放在较慢的服务器之前，以提高性能。反向代理通常会直接冒用Web服务器的名字和IP地址，这样所有的请求就会被发送给代理而不是服务器了。

>网络交换代理
>>可以将具有足够处理能力的代理放在网络之间的因特网对等交换上，通过缓存来减轻因特网节点的拥塞，并对流量进行监控。

### 6.3.2 代理的层次结构

可以通过代理层次结构将代理级联起来。在代理的层次结构中，会将报文从一个代理传给另一个代理，直到最终抵达原始服务器位置（然后通过代理传回给客户端）。

Proxy层次结构中的代理服务器被赋予了父（parent）和子（child）的关系。下一个入口代理被称为父代理，下一个出口代理被称为子代理。

但是层次不一定非得是静态的。代理服务器可以根据众多因素，将报文转发给一个不断变化的代理服务器和原始服务器集。

这里还有几个动态选择父代理的例子。

> 负载均衡
>> 子代理可能会根据当前父代理上的工作负载级别来决定如何选择一个父代理，以均衡负载。

>地理位置附近的路由
>>子代理可能会选择原始服务器所载物理区域的父代理。

> 协议/类型路由
> > 子代理可能会根据URI将报文转发到不同的父代理和原始服务器上去。某些特定类型的URI可能通过一些特殊代理服务器转发请求，以便进行特殊的协议处理。

>基于订购的路由
>>如果发布者为高性能服务额外付费了，它们的URI就会被转发到大型缓存或压缩引擎上去，以提高性能。

在不同的产品中，动态父路由逻辑的实现方式各有不同，包括使用配置文件、脚本语言和动态可执行插件等。



